<?php // -*- mode: php; tab-width: 2 -*-
//
//    Copyright (C) 2009, 2010 Pokermania
//
//    This program is free software: you can redistribute it and/or modify
//    it under the terms of the GNU Affero General Public License as published by
//    the Free Software Foundation, either version 3 of the License, or
//    (at your option) any later version.
//
//    This program is distributed in the hope that it will be useful,
//    but WITHOUT ANY WARRANTY; without even the implied warranty of
//    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//    GNU Affero General Public License for more details.
//
//    You should have received a copy of the GNU Affero General Public License
//    along with this program.  If not, see <http://www.gnu.org/licenses/>.
//


/**
 * @file
 * Poker 5.20: Search Buddy
 *
 */

/**
 * Includes the custom test case class with basic site configuration.
 */
require_once(dirname(__FILE__) .'/os_poker_test_case.tinc');

/**
 * Spec: 5.20: User search test case
 *
 * Verifies search for players in the user base of the system.
 *
 * @assert: Search page provides fields to search by for nickname, sex (gender), city, country and  level
 * @assert:  
 */
class OSPokerUserSearch extends OsPokerWebTestCase {

  /**
   * @var user object created and logged in during setUp process.
   */
  protected $skel_user;

  /**
   * Implementation of hook_info().
   */
  public static function getInfo() {
    return array(
      'name'        => '5.20 Search Buddy',
      'description' => 'User search functionality tests',
      'group'       => 'OS Poker Specifications',
    );
  }

  /**
   * Implementation of setUp().
   */
  function setUp() {
    // Enable required modules and set default site configuration.
    parent::setUp();

    /**
     * Register an 'skel_user' account and complete its profile.
     * This user has 'skel_user' for nickname.
     */
    $this->main_user = $this->drupalCreateUser();
    // Login the user, complete profile form
    $this->OsPokerLogin($this->main_user, array('profile_nickname' => 'main_user'));

  }

  /**
   * Implementation of tearDown().
   */
  function tearDown() {
    parent::tearDown();
  }

  
  function  testSearching() {
    $profiles = array(
      array('profile_country'=>'France', 'profile_city'=>'Paris', 'profile_gender'=>'Male'),
      array('profile_country'=>'France', 'profile_city'=>'Nantes', 'profile_gender'=>'Male'),
      array('profile_country'=>'Belgium', 'profile_city'=>'Bruxelles', 'profile_gender'=>'Male'),
      array('profile_country'=>'Belgium', 'profile_city'=>'Namur', 'profile_gender'=>'Male'),
      array('profile_country'=>'France', 'profile_city'=>'Paris', 'profile_gender'=>'Female'),
      array('profile_country'=>'France', 'profile_city'=>'Nantes', 'profile_gender'=>'Female'),
    );
    $users = array();
    foreach($profiles as $key => $profile) {
      $user = $this->OsPokerCreateUserWithProfile($profile);
      $users[$key] = CUserManager::instance()->User($user->uid);
    }

    
    //User search without param returns all
    $this->drupalPost('poker/buddies/search', array(), t("Send"));
//    $this->assertTrue(TRUE, $this->drupalGetContent());
    foreach($users as $user) {
      $this->assertText($user->profile_nickname, t('User %nickname found is search results', array('%nickname' => $user->profile_nickname)));
    }
    
    $searches = array(
      'profile_country' => 'France',
      'profile_city' => 'Paris',
      'profile_gender' => 'Male',
    );
    foreach($searches as $k => $v) {
      $this->drupalPost('poker/buddies/search', array($k => $v), t("Send"));
      foreach($users as $user) {
        if($user->{$k} == $v) {
          $this->assertText($user->profile_nickname, t('User %nickname found is search results', array('%nickname' => $user->profile_nickname)));
        }
        else {
          $this->assertNoText($user->profile_nickname, t('User %nickname not found is search results', array('%nickname' => $user->profile_nickname)));
        }
      }
    }
    foreach($profiles as $pk => $profile) {
      $this->drupalPost('poker/buddies/search', $profile, t("Send"));
      foreach($users as $uk => $user) {
        if($pk == $uk) {
          $this->assertText($user->profile_nickname, t('User %nickname found is search results', array('%nickname' => $user->profile_nickname)));
        } else {
          $this->assertNoText($user->profile_nickname, t('User %nickname not found is search results', array('%nickname' => $user->profile_nickname)));
        }
      }
      
    }
  }
}